name: release-assets

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Validate release tag and version file
        id: meta
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          if ! [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "tag must match vMAJOR.MINOR.PATCH, got: $tag" >&2
            exit 1
          fi

          file_version="$(awk -F'"' '/var Version = "/ {print $2; exit}' internal/buildinfo/version.go)"
          if [[ -z "$file_version" ]]; then
            echo "failed to read version from internal/buildinfo/version.go" >&2
            exit 1
          fi
          if [[ "$file_version" != "$tag" ]]; then
            echo "tag ($tag) does not match version file ($file_version)" >&2
            exit 1
          fi
          echo "tag=$tag" >>"$GITHUB_OUTPUT"

      - name: Build release assets
        run: |
          set -euo pipefail
          mkdir -p dist

          while read -r goos goarch; do
            [[ -n "${goos:-}" ]] || continue
            ext=""
            if [[ "$goos" == "windows" ]]; then
              ext=".exe"
            fi

            output="dist/zerodha_${goos}_${goarch}${ext}"
            GOOS="$goos" GOARCH="$goarch" CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o "$output" ./cmd/zerodha
          done <<'EOF'
          linux amd64
          linux arm64
          darwin amd64
          darwin arm64
          windows amd64
          windows arm64
          EOF

          (
            cd dist
            sha256sum zerodha_* > checksums.txt
          )

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/zerodha_linux_amd64
            dist/zerodha_linux_arm64
            dist/zerodha_darwin_amd64
            dist/zerodha_darwin_arm64
            dist/zerodha_windows_amd64.exe
            dist/zerodha_windows_arm64.exe
            dist/checksums.txt

